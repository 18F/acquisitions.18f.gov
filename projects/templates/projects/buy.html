{% extends "web/base.html" %}
{% load static from staticfiles %}

{% block resources %}
  <script src="{% static "js/a11y-dialog.min.js" %}"></script>
{% endblock %}

{% block content %}
{% if user in buy.technical_evaluation_panel.all and not user in buy.nda_signed.all %}
<div class="usa-alert usa-alert-warning">
  <div class="usa-alert-body">
    <h3 class="usa-alert-heading">You need to sign the NDA</h3>
    <p class="usa-alert-text">As a member of the technical evaluation panel, you'll need to sign the NDA before this buy can be issued. <a href="{% url 'buys:buy_nda' buy.id %}">Sign the NDA here</a>.</p>
  </div>
</div>
{% endif %}
<section class="usa-grid">
  <div class="usa-width-one-full">
    <h1>{{ buy.name }}</h1>
    {% if buy.is_private %}<div>This buy is not yet public.</div>{% endif %}
    <h2>Description</h2>
    <div id="description">
      {{ buy.description }}
    </div>
    <h2>Details</h2>
    <table class="usa-table-borderless">
      <tbody>
        <tr>
          <th scope="row">Status</th>
          <td>{{ buy.status }}</td>
        </tr>
        <tr>
          <th scope="row">Procurement Method</th>
          <td>{{ buy.get_procurement_method_display }}</td>
        </tr>
        <tr>
          <th scope="row">Set-Aside</th>
          <td>{{ buy.set_aside_status }}</td>
        </tr>
      </tbody>
    </table>
    <h2>Documents</h2>
    <div class="usa-grid-full acq-documents">
      <div class="usa-width-one-half" id="acquisition-plan">
        <h3>Acquisition Plan</h3>
        <p>Status: {{ buy.acquisition_plan_status }}</p>
        {% if buy.acquisition_plan %}
        <p><a href="{% url 'buys:document' buy.id 'acquisition_plan' %}">View</a></p>
        <p>Download: <a href="{% url 'buys:download' buy.id 'acquisition_plan' 'markdown' %}">.md</a> | <a href="{% url 'buys:download' buy.id 'acquisition_plan' 'docx' %}">.docx</a> | <a href="{% url 'buys:download' buy.id 'acquisition_plan' 'pdf' %}">.pdf</a></p>
        {% if perms.project.view_project %}
        <button onclick="connectButtons(this)" type="submit" name="generate_acquisition_plan" data-a11y-dialog-show="confirm-dialog">Regenerate</button>
        {% endif %}
        {% else %}
        {% if perms.project.view_project %}
        <form method="post">
          {% csrf_token %}
          <button type="submit" name="generate_acquisition_plan">Generate</button>
        </form>
        {% endif %}
        {% endif %}
      </div>
      <div class="usa-width-one-half" id="qasp">
        <h3>QASP</h3>
        <p>Status: {{ buy.qasp_status }}</p>
        {% if buy.qasp %}
        <p><a href="{% url 'buys:document' buy.id 'qasp' %}">View</a></p>
        <p>Download: <a href="{% url 'buys:download' buy.id 'qasp' 'markdown' %}">.md</a> | <a href="{% url 'buys:download' buy.id 'qasp' 'docx' %}">.docx</a> | <a href="{% url 'buys:download' buy.id 'qasp' 'pdf' %}">.pdf</a></p>
        {% if perms.project.view_project %}
        <button onclick="connectButtons(this)" type="submit" name="generate_qasp" data-a11y-dialog-show="confirm-dialog">Regenerate</button>
        {% endif %}
        {% else %}
        {% if perms.project.view_project %}
        <form method="post">
          {% csrf_token %}
          <button type="submit" name="generate_qasp">Generate</button>
        </form>
        {% endif %}
        {% endif %}
      </div>
    </div>
    <div class="usa-grid-full acq-documents">
      <div class="usa-width-one-half" id="market-research">
        <h3>Market Research Report</h3>
        <p>Status: {{ buy.market_research_status }}</p>
        {% if buy.market_research %}
        <p><a href="{% url 'buys:document' buy.id 'market_research' %}">View</a></p>
        <p>Download: <a href="{% url 'buys:download' buy.id 'market_research' 'markdown' %}">.md</a> | <a href="{% url 'buys:download' buy.id 'market_research' 'docx' %}">.docx</a> | <a href="{% url 'buys:download' buy.id 'market_research' 'pdf' %}">.pdf</a></p>
        {% if perms.project.view_project %}
        <button onclick="connectButtons(this)" type="submit" name="generate_market_research" data-a11y-dialog-show="confirm-dialog" formnovalidate>Regenerate</button>
        {% endif %}
        {% else %}
        {% if perms.project.view_project %}
        <form method="post">
          {% csrf_token %}
          <button type="submit" name="generate_market_research">Generate</button>
        </form>
        {% endif %}
        {% endif %}
      </div>
      <div class="usa-width-one-half" id="qasp">
        <h3>Another Document</h3>
    </div>
  </div>
</section>
{% endblock %}

{% block modals %}
<div id="confirm-dialog" class="dialog" aria-hidden="true">
  <div class="dialog-overlay" tabindex="-1" data-a11y-dialog-hide>
    <div class="dialog-content" aria-labelledby="dialogTitle" aria-describedby="dialogDescription" role="dialog">
      <div role="document">
        <h1 id="dialogTitle" tabindex="0">Regenerate document</h1>

        <p id="dialogDescription">Regenerating will overwrite the existing document, including any changes made. Are you sure?</p>

        <form action="" method="post" target="_blank">
          {% csrf_token %}
          <button type="submit" name="button" id="confirm-button">I'm sure</button>
        </form>
        <button data-a11y-dialog-hide class="dialog-close" title="Close registration form">&times;</button>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  var dialogEl = document.getElementById('confirm-dialog');
  var dialog = new A11yDialog(dialogEl);
  function connectButtons(el) {
    // Sets the form submission name based on the specific "regenerate" button clicked
    const confirm = document.getElementById('confirm-button');
    confirm.name = el.name
  }
</script>
{% endblock %}
